(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{441:function(s,a,e){"use strict";e.r(a);var t=e(8),n=function(s){s.options.__data__block__={flowchart_64a570e8:"s=>start: Start\ncondNet=>condition: network初始化\ninitNet=>operation: 初始化network\ncondCon=>condition: 容器判断\ndelCon=>operation: 删除容器\ne=>end: 启动\n\ns->condNet\ncondNet(no)->initNet->condCon\ncondNet(yes)->condCon\ncondCon(yes)->delCon->e\ncondCon(no,bottom)->e"}},r=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("微服务作为一个架构天然包含了许多进程模块，这是微服务的设计理念，将服务拆分成合适的粒度运行在不同的进程中，这给部署带来了一定的困难，好在容器的流行给部署带来了很大的简化，在开发、测试等非正式环境可能没有条件或者足够的资源去运行整个k8s集群，此时可以选择将微服务部署在同一个主机的Docker里，本文就讲述了如何在同一主机的Docker里部署微服务系统")]),s._v(" "),e("h2",{attrs:{id:"说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#说明"}},[s._v("#")]),s._v(" 说明")]),s._v(" "),e("p",[s._v("本次用例均在同一个主机里面运行，微服务架构基于SpringCloud,注册中心采用Euraka，在Docker中部署微服务主要要解决的问题的时服务之间通信的问题，因为Docker容器是相互隔离的，默认情况不能进行通信，Docker容器间通信方式大概有以下几种")]),s._v(" "),e("ol",[e("li",[s._v("通过Docker为容器分配的ip进行通信")]),s._v(" "),e("li",[s._v("通过link的方式进行容器之间连接来达到通信的方式")]),s._v(" "),e("li",[s._v("通过同一个network网络来通信")])]),s._v(" "),e("p",[s._v("通过ip的方式会导致微服务间通信有不确定性，因为每次容器启动ip可能都会变动；而通过link的方式则会增加部署的难度；故采用network的方式来达到容器通信的目的，本次运行的服务包含以下")]),s._v(" "),e("ol",[e("li",[s._v("eureka")]),s._v(" "),e("li",[s._v("zuul")]),s._v(" "),e("li",[s._v("app1")]),s._v(" "),e("li",[s._v("app2")]),s._v(" "),e("li",[s._v("app3")])]),s._v(" "),e("h2",{attrs:{id:"创建bridge网络"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建bridge网络"}},[s._v("#")]),s._v(" 创建bridge网络")]),s._v(" "),e("p",[s._v("docker默认的网络就是bridge网络，但它和我们自己创建的有一定的区别，具体区别可以参考"),e("a",{attrs:{href:"https://docs.docker.com/network/bridge/#differences-between-user-defined-bridges-and-the-default-bridge",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://docs.docker.com/network/bridge/#differences-between-user-defined-bridges-and-the-default-bridge"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("运行以下命令创建网络")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker network create --driver bridge appnet\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("可以查看刚才创建的网络")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker network "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"修改注册中心地址"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改注册中心地址"}},[s._v("#")]),s._v(" 修改注册中心地址")]),s._v(" "),e("p",[s._v("将各个模块的注册中心地址修改为以下值即可")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("eureka.client.serviceUrl.defaultZone"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://eureka:8763/eureka\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"添加容器参数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#添加容器参数"}},[s._v("#")]),s._v(" 添加容器参数")]),s._v(" "),e("p",[s._v("在启动eureka容器时添加*--network"),e("em",[s._v("和")]),s._v("--network-alias*参数")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker run -d --name eureka --network appnet --network-alias eureka -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8763")]),s._v(":8763  eureka\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("所有模块的启动命令就会成为下面的样子，整个微服务其实只需要暴露网关zuul的端口即可，暴露eureka的端口是为了方便查看服务在线情况")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker run -d --name eureka --network appnet --network-alias eureka -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8763")]),s._v(":8763  eureka\ndocker run -d --name zuul --network appnet --network-alias zuul -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8000")]),s._v(":8000  zuul\ndocker run -d --name app1 --network appnet --network-alias app1 app1\ndocker run -d --name app2 --network appnet --network-alias app2 app2\ndocker run -d --name app3 --network appnet --network-alias app3 app3\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h2",{attrs:{id:"脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#脚本"}},[s._v("#")]),s._v(" 脚本")]),s._v(" "),e("p",[s._v("为了避免频繁输入命令，现提供一个启动的脚本和批量启动的脚本")]),s._v(" "),e("h3",{attrs:{id:"思路"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#思路"}},[s._v("#")]),s._v(" 思路")]),s._v(" "),e("p",[s._v("启动一个模块的流程应是如下流程")]),s._v(" "),e("FlowChart",{attrs:{id:"flowchart_64a570e8",code:s.$dataBlock.flowchart_64a570e8,preset:"vue"}}),e("h3",{attrs:{id:"脚本内容"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#脚本内容"}},[s._v("#")]),s._v(" 脚本内容")]),s._v(" "),e("p",[s._v("单个脚本名称：start-app.sh")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -u\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -e\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"检查有没有创建名称为appnet网络"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("appnet")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("docker network "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" appnet"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -n "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$appnet")]),s._v('"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"没有初始化名称为appnet的网络，开始初始化"')]),s._v("\n  docker network create --driver bridge appnet\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"检查是否有'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v(' 服务的容器"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cid")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("docker "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -a "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" $name "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("}'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" -n "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cid")]),s._v('"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"删除'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v(' 服务的容器"')]),s._v("\n  docker "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -v -f "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cid")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"启动'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v(' 服务"')]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("extend")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v('"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eureka"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("extend")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-p 8763:8763"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("elif")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v('"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zuul"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("extend")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-p 8000:8000"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\ndocker run -d --name "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v(" --network appnet --network-alias "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$extend")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br")])]),e("p",[s._v("批量脚本：直接运行单个脚本即可")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" start-app.sh eureka\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" start-app.sh zuul\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" start-app.sh app1\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" start-app.sh app2\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" start-app.sh app3\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])])],1)}),[],!1,null,null,null);"function"==typeof n&&n(r);a.default=r.exports}}]);